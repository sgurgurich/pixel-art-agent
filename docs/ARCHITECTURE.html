<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Art Agent - System Architecture Documentation</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 5px;
            margin-top: 40px;
            page-break-after: avoid;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            page-break-after: avoid;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
            page-break-after: avoid;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            border: none;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
        }
        
        .header .date {
            color: #95a5a6;
            font-style: italic;
            margin-top: 10px;
        }
        
        .mermaid {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            page-break-inside: avoid;
        }
        
        .component {
            background: #ecf0f1;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            page-break-inside: avoid;
        }
        
        .component h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .tech-item {
            background: #fff;
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            page-break-inside: avoid;
        }
        
        .tech-item h4 {
            color: #3498db;
            margin-top: 0;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            page-break-inside: avoid;
        }
        
        pre code {
            background: none;
            color: inherit;
        }
        
        .flow-description {
            background: #e8f4f8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            page-break-inside: avoid;
        }
        
        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            page-break-inside: avoid;
        }
        
        .config-table th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .config-table td {
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .config-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            page-break-inside: avoid;
        }
        
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            page-break-after: always;
        }
        
        .toc h2 {
            margin-top: 0;
            border: none;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        
        .toc li {
            padding: 5px 0;
        }
        
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
            }
            
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Pixel Art Agent</h1>
            <div class="subtitle">System Architecture & Integration Documentation</div>
            <div class="date">Generated: November 22, 2025</div>
        </div>

        <div class="toc">
            <h2>Table of Contents</h2>
            <ul>
                <li><a href="#overview">1. System Overview</a></li>
                <li><a href="#architecture">2. High-Level Architecture</a></li>
                <li><a href="#components">3. Component Details</a></li>
                <li><a href="#data-flow">4. Data Flow & Integration</a></li>
                <li><a href="#ai-models">5. AI Model Integration</a></li>
                <li><a href="#image-generation">6. Image Generation Pipeline</a></li>
                <li><a href="#configuration">7. Configuration Guide</a></li>
                <li><a href="#deployment">8. Deployment Architecture</a></li>
            </ul>
        </div>

        <h2 id="overview">1. System Overview</h2>
        <p>
            The Pixel Art Agent is an AI-powered system that generates detailed pixel art specifications and actual 
            sprite images for video game development. It combines natural language processing through Ollama with 
            advanced image generation via Stable Diffusion to create both textual descriptions and visual assets.
        </p>

        <div class="tech-stack">
            <div class="tech-item">
                <h4>üçÉ Spring Boot 3.3.5</h4>
                <p>Core application framework providing REST APIs and dependency injection.</p>
            </div>
            <div class="tech-item">
                <h4>ü§ñ Ollama (Qwen 2.5:3b)</h4>
                <p>Local LLM for generating detailed pixel art specifications and descriptions.</p>
            </div>
            <div class="tech-item">
                <h4>üé® Stable Diffusion</h4>
                <p>Image generation model for creating actual pixel art sprites from descriptions.</p>
            </div>
            <div class="tech-item">
                <h4>üîß Spring AI 1.0.0-M3</h4>
                <p>Abstraction layer for AI model integration with Spring Boot.</p>
            </div>
        </div>

        <h2 id="architecture">2. High-Level Architecture</h2>
        
        <div class="mermaid">
graph TB
    subgraph "Client Layer"
        A[REST Client]
        B[API Request]
    end
    
    subgraph "Application Layer - Spring Boot"
        C[PixelArtController]
        D[PixelArtAgentService]
        E[ImageGenerationService]
    end
    
    subgraph "AI Integration Layer"
        F[Spring AI ChatClient]
        G[HTTP Client]
    end
    
    subgraph "AI Services"
        H[Ollama Server<br/>Port 11434]
        I[Qwen 2.5:3b Model]
        J[Stable Diffusion API<br/>Port 7860]
        K[SD Model v1.5]
    end
    
    A -->|POST /api/pixelart/generate| C
    C -->|1. Request Processing| D
    D -->|2. Generate Description| F
    F -->|3. Prompt| H
    H -->|4. Use Model| I
    I -->|5. Text Response| F
    F -->|6. Description| D
    D -->|7. Generate Image| E
    E -->|8. API Call| G
    G -->|9. txt2img| J
    J -->|10. Use Model| K
    K -->|11. Image Data| G
    G -->|12. Base64 PNG| E
    E -->|13. Image| D
    D -->|14. Complete Response| C
    C -->|15. JSON Response| A
    
    style A fill:#e74c3c,stroke:#c0392b,color:#fff
    style C fill:#3498db,stroke:#2980b9,color:#fff
    style D fill:#3498db,stroke:#2980b9,color:#fff
    style E fill:#3498db,stroke:#2980b9,color:#fff
    style F fill:#9b59b6,stroke:#8e44ad,color:#fff
    style G fill:#9b59b6,stroke:#8e44ad,color:#fff
    style H fill:#2ecc71,stroke:#27ae60,color:#fff
    style I fill:#2ecc71,stroke:#27ae60,color:#fff
    style J fill:#f39c12,stroke:#e67e22,color:#fff
    style K fill:#f39c12,stroke:#e67e22,color:#fff
        </div>

        <h2 id="components">3. Component Details</h2>

        <div class="component">
            <h3>3.1 PixelArtController</h3>
            <p><strong>Purpose:</strong> REST API endpoint layer that handles HTTP requests and responses.</p>
            <p><strong>Endpoints:</strong></p>
            <ul>
                <li><code>POST /api/pixelart/generate</code> - Generate complete pixel art specification with image</li>
                <li><code>POST /api/pixelart/generate/image</code> - Generate only the image asset</li>
                <li><code>POST /api/pixelart/variations</code> - Generate multiple variations</li>
                <li><code>POST /api/pixelart/refine</code> - Refine based on feedback</li>
            </ul>
            <p><strong>Responsibilities:</strong></p>
            <ul>
                <li>Request validation and sanitization</li>
                <li>Response formatting (JSON)</li>
                <li>Error handling and HTTP status codes</li>
                <li>CORS configuration for cross-origin requests</li>
            </ul>
        </div>

        <div class="component">
            <h3>3.2 PixelArtAgentService</h3>
            <p><strong>Purpose:</strong> Core business logic orchestrating AI interactions and response generation.</p>
            <p><strong>Key Capabilities:</strong></p>
            <ul>
                <li><strong>Prompt Engineering:</strong> Constructs detailed prompts for the Qwen model with specific technical requirements</li>
                <li><strong>Response Parsing:</strong> Extracts structured data from LLM responses (colors, animations, specifications)</li>
                <li><strong>Spritesheet Detection:</strong> Automatically determines if multiple frames are needed based on context</li>
                <li><strong>Image Orchestration:</strong> Coordinates between description generation and image creation</li>
            </ul>
            <pre><code>// Example prompt template
You are an expert pixel art and sprite design consultant.

Generate detailed technical description for:
- Asset Type: CHARACTER
- Description: brave knight
- Style: 16-bit pixel art
- Size: 32x32

Provide:
1. Visual description (shapes, proportions)
2. Color palette (5-8 hex codes)
3. Technical specs (dimensions, layers)
4. Animation suggestions
5. Special effects</code></pre>
        </div>

        <div class="component">
            <h3>3.3 ImageGenerationService</h3>
            <p><strong>Purpose:</strong> Manages communication with Stable Diffusion for actual image generation.</p>
            <p><strong>Features:</strong></p>
            <ul>
                <li><strong>Prompt Enhancement:</strong> Adds pixel art style markers and constraints</li>
                <li><strong>LoRA Support:</strong> Can integrate specialized pixel art LoRA models</li>
                <li><strong>Spritesheet Generation:</strong> Creates horizontal sprite strips with multiple frames</li>
                <li><strong>Fallback Handling:</strong> Provides placeholder images if SD is unavailable</li>
            </ul>
            <p><strong>Image Generation Parameters:</strong></p>
            <ul>
                <li>Steps: 50 (higher for better adherence to pixel art style)</li>
                <li>CFG Scale: 15 (maximum guidance for style consistency)</li>
                <li>Sampler: Euler a</li>
                <li>Resolution: 8x upscaled then downscaled for pixel effect</li>
            </ul>
        </div>

        <h2 id="data-flow">4. Data Flow & Integration</h2>

        <div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant AgentService
    participant ChatClient
    participant Ollama
    participant ImageService
    participant StableDiffusion

    Client->>Controller: POST /api/pixelart/generate<br/>{assetType, description, style, size}
    
    activate Controller
    Controller->>AgentService: generatePixelArt(request)
    
    activate AgentService
    AgentService->>AgentService: buildPrompt(request)
    AgentService->>ChatClient: prompt().user(prompt).call()
    
    activate ChatClient
    ChatClient->>Ollama: HTTP POST /api/generate
    Note over Ollama: Qwen 2.5:3b processes<br/>the prompt
    Ollama-->>ChatClient: Detailed description<br/>(colors, specs, animations)
    deactivate ChatClient
    
    AgentService->>AgentService: parseAiResponse()<br/>Extract: colors, animations, specs
    
    AgentService->>ImageService: generateImage(prompt, width, height,<br/>isSpritesheet, frameCount)
    
    activate ImageService
    ImageService->>ImageService: enhancePromptForPixelArt()
    Note over ImageService: Add pixel art markers:<br/>((16-bit)), ((retro sprite))<br/>negative prompts, etc.
    
    ImageService->>StableDiffusion: POST /sdapi/v1/txt2img<br/>{prompt, steps:50, cfg_scale:15}
    
    Note over StableDiffusion: Generate image with<br/>v1.5 model or<br/>Pixel Art LoRA
    
    StableDiffusion-->>ImageService: {images: [base64_png]}
    deactivate ImageService
    
    AgentService->>AgentService: attachImage(response, imageData)
    AgentService-->>Controller: PixelArtResponse<br/>{description, colors, specs,<br/>animations, imageData}
    deactivate AgentService
    
    Controller-->>Client: JSON Response with<br/>base64 encoded PNG
    deactivate Controller
        </div>

        <div class="flow-description">
            <strong>Flow Description:</strong>
            <ol>
                <li><strong>Request Reception:</strong> Client sends JSON request with asset requirements</li>
                <li><strong>Prompt Construction:</strong> Service builds detailed prompt with technical specifications</li>
                <li><strong>LLM Processing:</strong> Ollama/Qwen generates comprehensive pixel art description</li>
                <li><strong>Response Parsing:</strong> Extract structured data (hex colors, animation types, dimensions)</li>
                <li><strong>Image Prompt Enhancement:</strong> Add extreme pixel art style constraints and negative prompts</li>
                <li><strong>Image Generation:</strong> Stable Diffusion creates actual sprite with specified parameters</li>
                <li><strong>Response Assembly:</strong> Combine text description with base64-encoded image</li>
                <li><strong>Delivery:</strong> Return complete JSON response to client</li>
            </ol>
        </div>

        <h2 id="ai-models">5. AI Model Integration</h2>

        <h3>5.1 Ollama Integration (Text Generation)</h3>
        <div class="mermaid">
graph LR
    A[Spring AI ChatClient] -->|HTTP| B[Ollama Server<br/>localhost:11434]
    B --> C{Model Router}
    C -->|Selected| D[Qwen 2.5:3b<br/>1.9 GB]
    
    D --> E[Token Generation]
    E --> F[Response Streaming]
    F --> A
    
    style A fill:#9b59b6,stroke:#8e44ad,color:#fff
    style B fill:#2ecc71,stroke:#27ae60,color:#fff
    style D fill:#2ecc71,stroke:#27ae60,color:#fff
        </div>

        <div class="component">
            <h3>Qwen 2.5:3b Model Characteristics</h3>
            <table class="config-table">
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td>Model Size</td>
                    <td>1.9 GB</td>
                    <td>Quantized version for efficient local execution</td>
                </tr>
                <tr>
                    <td>Parameters</td>
                    <td>3 billion</td>
                    <td>Balanced for quality and performance</td>
                </tr>
                <tr>
                    <td>Context Window</td>
                    <td>32K tokens</td>
                    <td>Can handle detailed prompts and responses</td>
                </tr>
                <tr>
                    <td>Temperature</td>
                    <td>0.8</td>
                    <td>Balanced creativity vs consistency</td>
                </tr>
                <tr>
                    <td>Top-P</td>
                    <td>0.9</td>
                    <td>Nucleus sampling for varied but coherent output</td>
                </tr>
                <tr>
                    <td>Use Case</td>
                    <td>Technical Writing</td>
                    <td>Generates precise pixel art specifications</td>
                </tr>
            </table>
        </div>

        <div class="note">
            <strong>‚ö° Performance Note:</strong> Qwen 2.5:3b processes requests in 2-5 seconds on modern hardware, 
            making it suitable for real-time API responses. The model excels at structured technical descriptions 
            and understands pixel art terminology.
        </div>

        <h3>5.2 Stable Diffusion Integration (Image Generation)</h3>
        <div class="mermaid">
graph TB
    A[ImageGenerationService] -->|HTTP POST| B[Stable Diffusion WebUI API<br/>localhost:7860]
    
    B --> C{Model Selection}
    C -->|Default| D[v1-5-pruned-emaonly<br/>4 GB]
    C -->|Optional| E[Pixel Art LoRA<br/>163 MB]
    
    D --> F[txt2img Pipeline]
    E -.->|LoRA Weights| F
    
    F --> G[U-Net Diffusion]
    G --> H[VAE Decoder]
    H --> I[PNG Encoder]
    I --> A
    
    style A fill:#3498db,stroke:#2980b9,color:#fff
    style B fill:#f39c12,stroke:#e67e22,color:#fff
    style D fill:#f39c12,stroke:#e67e22,color:#fff
    style E fill:#e74c3c,stroke:#c0392b,color:#fff
        </div>

        <div class="component">
            <h3>Stable Diffusion Configuration</h3>
            <table class="config-table">
                <tr>
                    <th>Parameter</th>
                    <th>Value</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td>Base Model</td>
                    <td>v1-5-pruned-emaonly</td>
                    <td>Stable Diffusion 1.5 optimized weights</td>
                </tr>
                <tr>
                    <td>Steps</td>
                    <td>50</td>
                    <td>More iterations for style adherence</td>
                </tr>
                <tr>
                    <td>CFG Scale</td>
                    <td>15</td>
                    <td>Maximum prompt guidance</td>
                </tr>
                <tr>
                    <td>Sampler</td>
                    <td>Euler a</td>
                    <td>Good for pixel art generation</td>
                </tr>
                <tr>
                    <td>Resolution</td>
                    <td>8x requested</td>
                    <td>Generate high then downscale for pixel effect</td>
                </tr>
                <tr>
                    <td>Denoising</td>
                    <td>0.4</td>
                    <td>Control randomness in generation</td>
                </tr>
                <tr>
                    <td>CPU Flags</td>
                    <td>--no-half<br/>--precision full<br/>--disable-nan-check</td>
                    <td>CPU mode optimizations</td>
                </tr>
            </table>
        </div>

        <h3>5.3 Prompt Enhancement for Pixel Art</h3>
        <pre><code>// Enhanced prompt structure
StringBuilder enhancedPrompt = new StringBuilder();

// LoRA activation (if configured)
if (loraModel != null) {
    enhancedPrompt.append("<lora:pixel-art-xl:0.8> ");
}

// STRONG pixel art style markers
enhancedPrompt.append("((pixel art)), ((16-bit)), ((retro game sprite)), ");
enhancedPrompt.append("((NES style)), ((SNES style)), ");

// User description
enhancedPrompt.append(userDescription);

// EXTREME quality constraints
enhancedPrompt.append(", ((8-bit graphics)), ((low resolution)), ");
enhancedPrompt.append("((chunky pixels)), ((limited colors)), ");
enhancedPrompt.append("((no anti-aliasing)), ((no gradients)), ");

// Reference games for style
enhancedPrompt.append("Super Nintendo, Pokemon Red Blue style, ");
enhancedPrompt.append("Final Fantasy 6 sprite, Chrono Trigger sprite");

// Negative prompt
negative = "blurry, smooth, realistic, 3d render, gradients, 
           anti-aliasing, detailed textures, soft edges";</code></pre>

        <h2 id="image-generation">6. Image Generation Pipeline</h2>

        <div class="mermaid">
flowchart TD
    A[Request with Description] --> B{Check if<br/>Spritesheet<br/>Needed?}
    
    B -->|Yes - Multiple Animations| C[Calculate Frame Count<br/>idle:2, walk:4, attack:3]
    B -->|No - Single Sprite| D[Use Base Dimensions]
    
    C --> E[Set Width = base √ó frames<br/>Height = base]
    D --> E
    
    E --> F[Enhance Prompt<br/>Add pixel art markers]
    
    F --> G[Call SD API<br/>txt2img endpoint]
    
    G --> H{API<br/>Response?}
    
    H -->|200 OK| I[Parse JSON Response]
    H -->|Error/Timeout| J[Log Error<br/>Return Placeholder]
    
    I --> K[Extract base64 Image<br/>from images array]
    
    K --> L{Image<br/>Valid?}
    
    L -->|Yes| M[Return Base64 PNG]
    L -->|No| J
    
    M --> N[Attach to Response<br/>imageData field]
    
    J --> O[Return 1x1 Transparent PNG<br/>imageStatus: text-only]
    
    style A fill:#e8f4f8
    style M fill:#d5f4e6
    style J fill:#ffe6e6
        </div>

        <div class="flow-description">
            <strong>Pipeline Stages:</strong>
            <ol>
                <li><strong>Spritesheet Detection:</strong> Analyze request context and animation suggestions to determine if multiple frames needed</li>
                <li><strong>Frame Calculation:</strong> Assign typical frame counts per animation type (idle: 2, walk: 4, jump: 3, attack: 3)</li>
                <li><strong>Dimension Adjustment:</strong> For spritesheets, multiply width by frame count for horizontal layout</li>
                <li><strong>Prompt Enhancement:</strong> Add ((pixel art)), ((16-bit)) markers and strong negative prompts</li>
                <li><strong>API Communication:</strong> POST to /sdapi/v1/txt2img with full configuration</li>
                <li><strong>Response Handling:</strong> Parse JSON, extract base64 image from images array</li>
                <li><strong>Error Recovery:</strong> Return placeholder on failures, never crash the request</li>
                <li><strong>Integration:</strong> Attach base64 PNG to main response object</li>
            </ol>
        </div>

        <h2 id="configuration">7. Configuration Guide</h2>

        <h3>7.1 Application Properties</h3>
        <pre><code># application.properties

# Server Configuration
server.port=8080
spring.application.name=pixel-art-agent

# Ollama Configuration
spring.ai.ollama.base-url=http://localhost:11434
spring.ai.ollama.chat.options.model=qwen2.5:3b
spring.ai.ollama.chat.options.temperature=0.8
spring.ai.ollama.chat.options.top-p=0.9

# Logging
logging.level.com.pixelart.agent=DEBUG
logging.level.org.springframework.ai=DEBUG

# Agent Settings
pixelart.agent.max-iterations=3
pixelart.agent.default-style=pixel-art

# Image Generation Settings
pixelart.image.generation.enabled=true
pixelart.image.generation.api-url=http://localhost:7860
pixelart.image.generation.model=stable-diffusion

# Optional: LoRA Model
pixelart.image.generation.lora=pixel-art-xl
pixelart.image.generation.lora-strength=0.8</code></pre>

        <h3>7.2 Docker Container Configuration</h3>
        
        <div class="component">
            <h4>Ollama Container</h4>
            <pre><code>docker run -d --name ollama \
  -p 11434:11434 \
  -v ollama-data:/root/.ollama \
  ollama/ollama

# Pull the Qwen model
docker exec ollama ollama pull qwen2.5:3b</code></pre>
        </div>

        <div class="component">
            <h4>Stable Diffusion Container</h4>
            <pre><code>docker run -d --name stable-diffusion \
  -p 7860:7860 \
  -v sd-models:/data/StableDiffusion \
  -v sd-outputs:/data/outputs \
  -e CLI_ARGS="--api --listen --port 7860 \
    --no-half --precision full \
    --skip-torch-cuda-test \
    --disable-nan-check" \
  ghcr.io/neggles/sd-webui-docker:main</code></pre>
        </div>

        <h2 id="deployment">8. Deployment Architecture</h2>

        <div class="mermaid">
graph TB
    subgraph "Network - Docker Bridge"
        subgraph "Container 1 - Application"
            A[Spring Boot Application<br/>Port 8080]
        end
        
        subgraph "Container 2 - Ollama"
            B[Ollama Server<br/>Port 11434]
            C[Qwen 2.5:3b Model<br/>1.9 GB]
        end
        
        subgraph "Container 3 - Stable Diffusion"
            D[SD WebUI API<br/>Port 7860]
            E[v1.5 Model<br/>4 GB]
            F[Pixel Art LoRA<br/>163 MB - Optional]
        end
    end
    
    subgraph "Persistent Storage"
        G[(Ollama Volume<br/>Model Storage)]
        H[(SD Models Volume<br/>Model Storage)]
        I[(SD Outputs Volume<br/>Generated Images)]
    end
    
    subgraph "External Access"
        J[Client Applications]
        K[Web Browsers]
    end
    
    J -->|HTTP :8080| A
    K -->|HTTP :8080| A
    
    A -->|HTTP :11434| B
    B --> C
    A -->|HTTP :7860| D
    D --> E
    D -.->|If configured| F
    
    B <-->|Read/Write| G
    D <-->|Read| H
    D -->|Write| I
    
    style A fill:#3498db,stroke:#2980b9,color:#fff
    style B fill:#2ecc71,stroke:#27ae60,color:#fff
    style C fill:#2ecc71,stroke:#27ae60,color:#fff
    style D fill:#f39c12,stroke:#e67e22,color:#fff
    style E fill:#f39c12,stroke:#e67e22,color:#fff
    style F fill:#e74c3c,stroke:#c0392b,color:#fff
    style G fill:#95a5a6,stroke:#7f8c8d,color:#fff
    style H fill:#95a5a6,stroke:#7f8c8d,color:#fff
    style I fill:#95a5a6,stroke:#7f8c8d,color:#fff
        </div>

        <div class="component">
            <h3>System Requirements</h3>
            <table class="config-table">
                <tr>
                    <th>Component</th>
                    <th>RAM</th>
                    <th>Storage</th>
                    <th>CPU</th>
                </tr>
                <tr>
                    <td>Spring Boot Application</td>
                    <td>1-2 GB</td>
                    <td>100 MB</td>
                    <td>2 cores recommended</td>
                </tr>
                <tr>
                    <td>Ollama + Qwen 2.5:3b</td>
                    <td>4-6 GB</td>
                    <td>2 GB</td>
                    <td>4 cores recommended</td>
                </tr>
                <tr>
                    <td>Stable Diffusion (CPU)</td>
                    <td>8-16 GB</td>
                    <td>6-8 GB</td>
                    <td>8+ cores (generation is slow)</td>
                </tr>
                <tr>
                    <td><strong>Total Minimum</strong></td>
                    <td><strong>16 GB</strong></td>
                    <td><strong>10 GB</strong></td>
                    <td><strong>8 cores</strong></td>
                </tr>
            </table>
        </div>

        <div class="note">
            <strong>üöÄ Performance Tip:</strong> For production deployments, consider using GPU acceleration for 
            Stable Diffusion. This can reduce image generation time from 30-60 seconds (CPU) to 2-5 seconds (GPU). 
            Ollama also benefits from GPU acceleration, reducing response time from 3-5 seconds to under 1 second.
        </div>

        <h2>9. API Examples</h2>

        <h3>9.1 Generate Pixel Art with Image</h3>
        <pre><code>POST http://localhost:8080/api/pixelart/generate
Content-Type: application/json

{
  "assetType": "CHARACTER",
  "description": "brave knight with sword and shield",
  "style": "16-bit pixel art",
  "colorPalette": "medieval fantasy",
  "size": "32x32",
  "additionalContext": "animation frames for walk cycle"
}

Response:
{
  "detailedDescription": "### Character Asset Specification...",
  "suggestedColors": ["#2C3E50", "#E74C3C", "#ECF0F1", "#3498DB"],
  "specifications": {
    "size": "32x32",
    "assetType": "CHARACTER",
    "frameCount": 4,
    "orientation": "front-facing",
    "layers": ["background", "base", "details", "highlights"]
  },
  "animationSuggestions": ["idle", "walk"],
  "style": "16-bit pixel art",
  "imageData": "iVBORw0KGgoAAAANSUhEUgAA...[base64]",
  "imageStatus": "spritesheet-generated",
  "generatedAt": "2025-11-22T14:00:00"
}</code></pre>

        <h3>9.2 Generate Image Only</h3>
        <pre><code>POST http://localhost:8080/api/pixelart/generate/image
Content-Type: application/json

{
  "assetType": "ITEM",
  "description": "health potion bottle",
  "style": "pixel art",
  "size": "16x16"
}

Response: Binary PNG image file</code></pre>

        <h2>10. Troubleshooting</h2>

        <div class="component">
            <h3>Common Issues and Solutions</h3>
            
            <h4>Issue: Ollama Connection Refused</h4>
            <p><strong>Symptom:</strong> Error connecting to localhost:11434</p>
            <p><strong>Solution:</strong></p>
            <ul>
                <li>Verify Ollama container is running: <code>docker ps | grep ollama</code></li>
                <li>Check port mapping: <code>docker port ollama</code></li>
                <li>Ensure model is pulled: <code>docker exec ollama ollama list</code></li>
            </ul>

            <h4>Issue: Stable Diffusion Returns Placeholder</h4>
            <p><strong>Symptom:</strong> imageStatus is "text-only", 70-byte images</p>
            <p><strong>Solution:</strong></p>
            <ul>
                <li>Check SD container logs: <code>docker logs stable-diffusion --tail 50</code></li>
                <li>Verify API is accessible: <code>curl http://localhost:7860/sdapi/v1/sd-models</code></li>
                <li>Check application logs for "ERROR" messages related to Stable Diffusion</li>
                <li>Ensure --disable-nan-check flag is set for CPU mode</li>
            </ul>

            <h4>Issue: Out of Memory</h4>
            <p><strong>Symptom:</strong> Container crashes or system freezes</p>
            <p><strong>Solution:</strong></p>
            <ul>
                <li>Reduce Qwen model size to smaller variant (1.8b instead of 3b)</li>
                <li>Limit concurrent requests with rate limiting</li>
                <li>Increase Docker memory limits in Docker Desktop settings</li>
                <li>Consider using GPU for better memory management</li>
            </ul>
        </div>

        <h2>11. Future Enhancements</h2>
        <ul>
            <li>‚úÖ LoRA model support for specialized pixel art styles</li>
            <li>‚úÖ Spritesheet generation with multiple frames</li>
            <li>üîÑ GPU acceleration for faster image generation</li>
            <li>üîÑ Persistent volume configuration for model storage</li>
            <li>üìã Animation sequence generation (idle ‚Üí walk ‚Üí attack)</li>
            <li>üìã Color palette extraction from reference images</li>
            <li>üìã Batch generation API for multiple assets</li>
            <li>üìã WebSocket support for real-time generation progress</li>
            <li>üìã Integration with game engines (Unity, Godot)</li>
        </ul>

        <div class="header" style="margin-top: 60px; border-top: 2px solid #ddd; padding-top: 40px;">
            <p style="color: #95a5a6; font-size: 0.9em;">
                ¬© 2025 Pixel Art Agent Project | Documentation v1.0
            </p>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>
